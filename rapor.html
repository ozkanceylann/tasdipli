<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Raporlar</title>

  <link rel="stylesheet" href="style.css" />

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .report-card {
      background:#fff;
      padding:20px;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.12);
      flex:1;
      min-width:220px;
    }
    .report-card h3 {
      margin:0;
      font-size:16px;
      color:#333;
    }
    .report-card .value {
      font-size:26px;
      font-weight:bold;
      margin-top:10px;
    }
  </style>
</head>

<body>

<div class="content-area" style="margin-left:260px; padding:25px;">

  <h2 style="margin-bottom:20px;">ðŸ“Š Raporlama EkranÄ±</h2>

  <!-- Tarih Filtresi -->
  <div style="background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.12);margin-bottom:25px;">
    <label><b>BaÅŸlangÄ±Ã§ Tarihi:</b></label>
    <input type="date" id="startDate" />

    &nbsp;&nbsp;
    <label><b>BitiÅŸ Tarihi:</b></label>
    <input type="date" id="endDate" />

    <button class="btn-primary" onclick="loadReport()">Raporla</button>
  </div>

  <!-- Grafik 1 -->
  <div style="background:#fff;padding:20px;border-radius:12px;margin-bottom:25px;box-shadow:0 2px 8px rgba(0,0,0,0.12);">
    <h3>ðŸ“ˆ GÃ¼nlÃ¼k SipariÅŸ SayÄ±sÄ±</h3>
    <canvas id="dailyChart" style="max-height:300px;"></canvas>
  </div>

  <!-- Grafik 2 -->
  <div style="background:#fff;padding:20px;border-radius:12px;margin-bottom:25px;box-shadow:0 2px 8px rgba(0,0,0,0.12);">
    <h3>ðŸ“ž SipariÅŸ Alan KiÅŸiye GÃ¶re SatÄ±ÅŸ</h3>
    <canvas id="salesByTel" style="max-height:300px;"></canvas>
  </div>

  <!-- Ã–zet Kartlar -->
  <div id="summaryCards" style="display:flex;gap:20px;flex-wrap:wrap;margin-bottom:25px;"></div>

  <!-- Detay Tablosu -->
  <div class="table-wrapper">
    <table class="orders-table">
      <thead>
        <tr>
          <th>No</th>
          <th>Ä°sim</th>
          <th>Tutar</th>
          <th>Durum</th>
          <th>Tarih</th>
          <th>SipariÅŸ Alan Tel</th>
        </tr>
      </thead>
      <tbody id="reportTable"></tbody>
    </table>
  </div>

</div>

<script>
const db = supabase.createClient(
  "https://jarsxtpqzqzhlshpmgot.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphcnN4dHBxenF6aGxzaHBtZ290Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyODExMTcsImV4cCI6MjA3Nzg1NzExN30.98oYONSkb8XSDrfGW2FxhFmt2BLB5ZRo3Ho50GhZYgE"
);

const firmaName = localStorage.getItem("firma").toLowerCase();
const TABLE = firmaName + "_siparisler";

let chart1 = null;
let chart2 = null;

async function loadReport(){
  const start = startDate.value;
  const end   = endDate.value;

  let q = db.from(TABLE).select("*");

  if(start) q = q.gte("tarih", start);
  if(end)   q = q.lte("tarih", end + " 23:59:59");

  q = q.order("tarih",{ascending:false});

  const { data, error } = await q;
  if(error) return alert("Hata: " + error.message);

  renderReport(data);
}

function renderReport(rows){
  const table = document.getElementById("reportTable");
  const summary = document.getElementById("summaryCards");
  table.innerHTML = "";
  summary.innerHTML = "";

  if(!rows || rows.length === 0){
    table.innerHTML = `<tr><td colspan="6">KayÄ±t bulunamadÄ±</td></tr>`;
    return;
  }

  let toplamTutar = 0;
  let adet = rows.length;
  let kargolanan = rows.filter(r => r.kargo_durumu === "KargolandÄ±").length;

  rows.forEach(r=>{
    toplamTutar += Number(r.toplam_tutar || 0);

    table.innerHTML += `
      <tr>
        <td>${r.siparis_no}</td>
        <td>${r.ad_soyad}</td>
        <td>${r.toplam_tutar} TL</td>
        <td>${r.kargo_durumu}</td>
        <td>${(r.tarih||'').substring(0,10)}</td>
        <td>${r.siparis_tel}</td>
      </tr>
    `;
  });

  summary.innerHTML = `
    <div class="report-card">
      <h3>Toplam SipariÅŸ</h3>
      <div class="value">${adet}</div>
    </div>

    <div class="report-card">
      <h3>Toplam Tutar</h3>
      <div class="value">${toplamTutar} TL</div>
    </div>

    <div class="report-card">
      <h3>Kargolanan</h3>
      <div class="value">${kargolanan}</div>
    </div>
  `;

  buildCharts(rows);
}

// ==============================
// GRAFÄ°KLER
// ==============================
function buildCharts(rows){

  // GÃ¼nlÃ¼k grafiÄŸi
  const daily = {};
  rows.forEach(r=>{
    const d = (r.tarih||'').substring(0,10);
    daily[d] = (daily[d]||0)+1;
  });

  const labels1 = Object.keys(daily);
  const values1 = Object.values(daily);

  if(chart1) chart1.destroy();
  chart1 = new Chart(document.getElementById("dailyChart"),{
    type:"line",
    data:{ labels:labels1, datasets:[{ label:"GÃ¼nlÃ¼k SipariÅŸ", data:values1, borderWidth:3 }] }
  });

  // SipariÅŸ Alan Tel grafiÄŸi
  const seller = {};
  rows.forEach(r=>{
    const tel = r.siparis_tel || "Bilinmiyor";
    seller[tel] = (seller[tel]||0)+1;
  });

  const labels2 = Object.keys(seller);
  const values2 = Object.values(seller);

  if(chart2) chart2.destroy();
  chart2 = new Chart(document.getElementById("salesByTel"),{
    type:"bar",
    data:{ labels:labels2, datasets:[{ label:"SipariÅŸ SayÄ±sÄ±", data:values2, borderWidth:2 }] }
  });
}

</script>

</body>
</html>
