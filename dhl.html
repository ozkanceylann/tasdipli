<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DHL Kargolama</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <script src="config.js"></script>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Sayfa içi sade stiller (mevcut tasarıma uyumlu, minimal) */
    .kargo-wrap{display:flex;min-height:100vh}
    .kargo-left{width:320px;background:#111827;color:#fff;padding:18px 16px}
    .kargo-left h2{margin:0 0 8px;font-size:18px}
    .kargo-left .desc{opacity:.8;font-size:12px;margin-bottom:12px}
    .kargo-left label{font-size:12px;display:block;margin:10px 0 4px}
    .kargo-left input{width:100%;padding:9px;border-radius:8px;border:1px solid #2b3445;background:#0f172a;color:#e5e7eb}
    .kargo-left .btn{width:100%;margin-top:10px;padding:10px 12px;border:none;border-radius:8px;background:#2563eb;color:#fff;cursor:pointer}
    .kargo-left .muted{font-size:12px;opacity:.85;margin-top:8px}
    .token-chip{margin-top:10px;padding:8px;border-radius:8px;background:#064e3b;color:#d1fae5;display:none}
    .token-chip.error{background:#7f1d1d;color:#fee2e2}

    .kargo-right{flex:1;padding:20px}
    .box{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:14px 14px 16px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .box h3{margin:0 0 12px;font-size:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row > .box{margin:0}
    textarea.req,textarea.res{width:100%;min-height:210px;border:1px solid #d1d5db;border-radius:8px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{padding:10px 14px;border:none;border-radius:8px;background:#0d6efd;color:#fff;cursor:pointer}
    .btn.secondary{background:#10b981}
    .btn.warn{background:#f59e0b}
    .status-pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-size:12px}
    .status-ok{background:#ecfdf5;color:#065f46}
    .status-err{background:#fef2f2;color:#991b1b}
    .mini{font-size:12px;padding:6px 10px}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:10px}

    @media(max-width:1100px){
      .row{grid-template-columns:1fr}
      .two-col{grid-template-columns:1fr}
      .kargo-left{width:100%;position:sticky;top:0}
      .kargo-wrap{flex-direction:column}
    }
  </style>
</head>
<body>

<!-- SOL: Login & Token -->
<div class="kargo-wrap">
  <aside class="kargo-left">
    <h2>DHL Login</h2>
    <div class="desc">Bu sayfa <b>brand.config.json</b> içindeki marka adına göre otomatik çalışır. Firma seçimi gerekmez.</div>

    <label>Marka</label>
    <input id="brandName" type="text" disabled value="Yükleniyor..." />

    <label>Müşteri No (Kullanıcı Adı)</label>
    <input id="kullanici" type="text" placeholder="DHL müşteri numarası" />

    <label>Şifre</label>
    <input id="sifre" type="password" placeholder="DHL şifresi" />

    <button class="btn" id="btnLogin" onclick="handleLogin()">Giriş Yap / Token Al</button>
    <div id="tokenChip" class="token-chip">Token alındı • 8 saat geçerli</div>

    <div class="muted">Not: <b>Client ID</b> ve <b>Client Secret</b> Supabase'deki <i>dhl_integrasyon_ayarlari</i> tablosundan otomatik çekilir ve <u>asla</u> ekranda gösterilmez.</div>
  </aside>

  <!-- SAĞ: Test gönderim & log görüntüleme -->
  <main class="kargo-right">

    <div class="box two-col">
      <div>
        <h3>Gönderi JSON (kargoya gidecek veri)</h3>
        <textarea id="reqBox" class="req">{
  "referans_no": "",
  "alici_adi": "",
  "telefon": "",
  "adres": "",
  "il": "",
  "ilce": "",
  "kg": 1,
  "adet": 1
}</textarea>
        <div class="actions">
          <button class="btn" onclick="validateOnly()">Doğrula</button>
          <button class="btn secondary" onclick="sendShipment()">TEST API'ye Gönder</button>
          <button class="btn warn mini" onclick="preFillFromSelected()">Seçili siparişten doldur (opsiyonel)</button>
        </div>
        <div id="statusArea" style="margin-top:10px"></div>
      </div>
      <div>
        <h3>DHL/MNG Yanıtı</h3>
        <textarea id="resBox" class="res" readonly></textarea>
        <div class="actions">
          <button class="btn mini" onclick="copyText('resBox')">Yanıtı Kopyala</button>
          <button class="btn mini" onclick="copyText('reqBox')">İsteği Kopyala</button>
        </div>
      </div>
    </div>

    <div class="box">
      <h3>Açıklamalar</h3>
      <ul>
        <li><b>Token</b> alınmadan gönderim yapılamaz. Token süresi dolarsa sayfa uyarır.</li>
        <li><b>200/201</b> dönerse işlem başarılı sayılır ve ilgili sipariş <b>Kargolandı</b> yapılır.</li>
        <li>Hatalı veri varsa zorunlu alanlar kırmızı uyarı olarak görünür, gönderim engellenir.</li>
      </ul>
    </div>

  </main>
</div>

<!-- Supabase & App -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/************************************
 * 1) GLOBALS
 ************************************/
let db;              // supabase client
let BRAND = null;    // brand.config.json -> CONFIG.brand
let client_id = null, client_secret = null; // dhl_integrasyon_ayarlari
let token_url = null, shipment_url = null, api_version = "1.0";

let activeToken = null;   // alınan JWT
let tokenExpireAt = null; // ISO string

/************************************
 * 2) INIT
 ************************************/
(async function init(){
  await window.waitConfig?.();
  BRAND = (window.CONFIG?.brand || "").toLowerCase();
  document.getElementById('brandName').value = BRAND || "(brand yok)";

  // Supabase client (mevcut projedeki sabitlerle birebir)
  const SUPABASE_URL = "https://jarsxtpqzqzhlshpmgot.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphcnN4dHBxenF6aGxzaHBtZ290Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyODExMTcsImV4cCI6MjA3Nzg1NzExN30.98oYONSkb8XSDrfGW2FxhFmt2BLB5ZRo3Ho50GhZYgE";
  db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // 1) Global entegrasyon ayarlarını çek (client id/secret + URL'ler)
  await loadIntegrationSettings();
  // 2) Firma hesabını çek (musteri_no / sifre) ve alanlara doldur
  await loadFirmAccount();
  // 3) LocalStorage'da geçerli token varsa yükle
  loadLocalToken();
})();

async function loadIntegrationSettings(){
  const { data, error } = await db
    .from('dhl_integrasyon_ayarlari')
    .select('*')
    .limit(1)
    .maybeSingle();
  if(error){ console.warn('integration error', error); return; }
  if(!data) return;
  client_id = data["X-IBM-Client-Id"]; client_secret = data["X-IBM-Client-Secret"];
  token_url = data.token_url; shipment_url = data.shipment_url; api_version = data["x-api-version"] || '1.0';
}

async function loadFirmAccount(){
  if(!BRAND) return;
  const { data, error } = await db
    .from('dhl_firma_hesaplari')
    .select('customerNumber, password, son_token, son_token_expire')
    .eq('firma_adi', BRAND)
    .maybeSingle();
  if(error){ console.warn('firma hesap error', error); return; }
  if(!data) return;
  document.getElementById('kullanici').value = data.customerNumber || '';
  document.getElementById('sifre').value = data.password || '';
  if(data.son_token && data.son_token_expire){
    activeToken = data.son_token;
    tokenExpireAt = data.son_token_expire;
    reflectTokenUI();
  }
}

function loadLocalToken(){
  try{
    const t = localStorage.getItem('dhl_token');
    const ex = localStorage.getItem('dhl_token_exp');
    if(t && ex && new Date(ex) > new Date()){
      activeToken = t; tokenExpireAt = ex; reflectTokenUI();
    }
  }catch{}
}

function reflectTokenUI(){
  const chip = document.getElementById('tokenChip');
  if(activeToken && tokenExpireAt && new Date(tokenExpireAt) > new Date()){
    const leftMin = Math.max(0, Math.floor((new Date(tokenExpireAt) - new Date())/60000));
    chip.classList.remove('error');
    chip.textContent = `Token aktif • ${leftMin} dk. kaldı`;
    chip.style.display = 'block';
  }else{
    chip.classList.add('error');
    chip.textContent = 'Token yok / süresi doldu';
    chip.style.display = 'block';
  }
}

/************************************
 * 3) LOGIN / TOKEN
 ************************************/
async function handleLogin(){
  const musteri = document.getElementById('kullanici').value.trim();
  const sifre   = document.getElementById('sifre').value.trim();
  if(!musteri || !sifre){ return alert('Müşteri no ve şifre zorunlu'); }
  if(!client_id || !client_secret || !token_url){ return alert('Entegrasyon ayarları eksik (client/secret/token_url)'); }

  // MNG->DHL test örneği: token için gerekli header'lar
  try{
    const res = await fetch(token_url, {
      method: 'POST',
      headers: {
        'X-IBM-Client-Id': client_id,
        'X-IBM-Client-Secret': client_secret,
        'accept': 'application/json',
        'content-type': 'application/json',
        'x-api-version': api_version
      },
      body: JSON.stringify({ username: musteri, password: sifre }) // GUIDE'a göre gerekirse boş {}
    });

    const raw = await res.text();
    let data = {};
    try{ data = JSON.parse(raw); }catch{ data = { raw }; }

    if(res.status === 200 || res.status === 201){
      activeToken = data.access_token || data.token || null;
      // expires / expires_in'den tahminî expiry
      const ex = data.expires || data.exp || null;
      tokenExpireAt = ex ? new Date(ex).toISOString() : new Date(Date.now()+8*3600*1000).toISOString();

      // Supabase'e kaydet
      if(BRAND){
        await db.from('dhl_firma_hesaplari')
          .update({ customerNumber: musteri, password: sifre, son_token: activeToken, son_token_expire: tokenExpireAt })
          .eq('firma_adi', BRAND);
      }
      // LocalStorage
      localStorage.setItem('dhl_token', activeToken||'');
      localStorage.setItem('dhl_token_exp', tokenExpireAt||'');

      reflectTokenUI();
      alert('Token başarıyla alındı');
    }else{
      activeToken = null; tokenExpireAt = null; reflectTokenUI();
      alert('Token alınamadı: '+raw);
    }
  }catch(err){
    activeToken = null; tokenExpireAt = null; reflectTokenUI();
    alert('Token hatası: '+err);
  }
}

/************************************
 * 4) VALIDATION
 ************************************/
function validateOnly(){
  const { ok, errors } = validateJSON();
  const area = document.getElementById('statusArea');
  if(ok){ area.innerHTML = `<span class="status-pill status-ok">✔ Zorunlu alan kontrolü geçti</span>`; }
  else{ area.innerHTML = `<span class="status-pill status-err">✖ Eksik/Hatalı alanlar: ${errors.join(', ')}</span>`; }
}

function validateJSON(){
  let bodyText = document.getElementById('reqBox').value;
  let obj;
  try{ obj = JSON.parse(bodyText); }catch{ return { ok:false, errors:['Geçersiz JSON'] }; }
  const need = ['referans_no','alici_adi','telefon','adres','il','ilce','kg','adet'];
  const missing = need.filter(k=> !obj[k] && obj[k] !== 0);
  if(missing.length) return { ok:false, errors:missing };
  if(isNaN(Number(obj.kg)) || isNaN(Number(obj.adet))) return { ok:false, errors:['kg/adet sayı olmalı'] };
  return { ok:true, errors:[] };
}

/************************************
 * 5) SHIPMENT GÖNDERİMİ (TEST)
 ************************************/
async function sendShipment(){
  if(!activeToken || !tokenExpireAt || new Date(tokenExpireAt) <= new Date()){
    return alert('Token geçersiz veya süresi dolmuş. Lütfen tekrar giriş yapın.');
  }
  if(!shipment_url){ return alert('shipment_url tanımlı değil'); }

  const v = validateJSON();
  if(!v.ok){ return validateOnly(); }

  const bodyText = document.getElementById('reqBox').value;
  let statusHtml = '';
  try{
    const res = await fetch(shipment_url, {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer '+activeToken,
        'accept': 'application/json',
        'content-type': 'application/json'
      },
      body: bodyText
    });

    const rawText = await res.text();
    document.getElementById('resBox').value = rawText;

    if(res.status === 200 || res.status === 201){
      statusHtml = `<span class=\"status-pill status-ok\">✔ ${res.status} Başarılı</span>`;
      // Sipariş durumunu Kargolandı yap (referans_no alanını siparis_no olarak varsayıyoruz)
      try{
        const parsed = JSON.parse(bodyText);
        const refNo = Number(parsed.referans_no);
        if(!isNaN(refNo)){
          await db.from('queen_siparisler')
            .update({ kargo_durumu:'Kargolandı' })
            .eq('siparis_no', refNo);
        }
      }catch{}
      alert('Gönderim başarılı');
    }else{
      statusHtml = `<span class=\"status-pill status-err\">✖ ${res.status} Hata</span>`;
      alert('Hata oluştu. Yanıt detayını kontrol edin.');
    }
  }catch(err){
    statusHtml = `<span class=\"status-pill status-err\">✖ İstek hatası: ${String(err)}</span>`;
  }
  document.getElementById('statusArea').innerHTML = statusHtml;
}

/************************************
 * 6) KOLAYLIK
 ************************************/
function copyText(id){
  const el = document.getElementById(id);
  el.select();
  document.execCommand('copy');
}

function preFillFromSelected(){
  // Bu fonksiyon istenirse mevcut sayfadaki seçili siparişten formu doldurmak için kullanılabilir
  // Şimdilik sadece örnek doldurma bırakıyoruz.
  const ex = {
    referans_no: "10001",
    alici_adi: "Ad Soyad",
    telefon: "05001234567",
    adres: "Mahalle Cad. Sok. No:1",
    il: "İstanbul",
    ilce: "Kadıköy",
    kg: 1,
    adet: 1
  };
  document.getElementById('reqBox').value = JSON.stringify(ex, null, 2);
}
</script>
</body>
</html>
